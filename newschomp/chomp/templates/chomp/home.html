{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>newschomp</title>
    <link rel="stylesheet" href="{% static 'chomp/css/style.css' %}">
</head>
<body>
    <main class="feed">
        <section class="feed-section feed-world">
            <div id="world-content">
            {% if world_article %}
                <article class="article-card">
                    <img src="{% static 'chomp/images/mouth.png' %}" alt="Refresh" title="GENERATE NEW CHOMP" class="refresh-btn" data-category="world" data-frame1="{% static 'chomp/images/mouth.png' %}" data-frame2="{% static 'chomp/images/mouth-2.png' %}">
                    <h3 class="article-title">
                        <a href="{{ world_article.url }}" target="_blank" title="{{ world_article.url }}">
                            {% if world_article.ai_title %}
                                {{ world_article.ai_title }}
                            {% else %}
                                {{ world_article.title }}
                            {% endif %}
                        </a>
                    </h3>
                    {% if world_article.image_url %}
                        <img src="{{ world_article.image_url }}" alt="{{ world_article.title }}" class="article-image">
                    {% endif %}
                    {% if world_article.summary %}
                        <ul class="summary">
                            {% for line in world_article.summary.splitlines %}
                                {% if line.strip %}
                                    <li>{{ line }}</li>
                                {% endif %}
                            {% endfor %}
                        </ul>
                    {% endif %}
                    <div class="article-meta">
                        <div class="meta-line">
                            <span class="source">{{ world_article.source }}</span>
                            {% if world_article.pub_date %}
                                <span class="pub-date">{{ world_article.pub_date|date:"M d, Y" }}</span>
                            {% endif %}
                        </div>
                        {% if world_article.topics %}
                            <div class="topics">
                                {% for topic in world_article.topics %}
                                    <span class="topic">{{ topic }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </article>
            {% else %}
                <div class="empty-state">No world news yet</div>
            {% endif %}
            </div>
        </section>

        <section class="feed-section feed-color">
            <div id="color-content">
            {% if color_article %}
                <article class="article-card">
                    <img src="{% static 'chomp/images/mouth.png' %}" alt="Refresh" title="GENERATE NEW CHOMP" class="refresh-btn" data-category="color" data-frame1="{% static 'chomp/images/mouth.png' %}" data-frame2="{% static 'chomp/images/mouth-2.png' %}">
                    <h3 class="article-title">
                        <a href="{{ color_article.url }}" target="_blank" title="{{ color_article.url }}">
                            {% if color_article.ai_title %}
                                {{ color_article.ai_title }}
                            {% else %}
                                {{ color_article.title }}
                            {% endif %}
                        </a>
                    </h3>
                    {% if color_article.image_url %}
                        <img src="{{ color_article.image_url }}" alt="{{ color_article.title }}" class="article-image">
                    {% endif %}
                    {% if color_article.summary %}
                        <ul class="summary">
                            {% for line in color_article.summary.splitlines %}
                                {% if line.strip %}
                                    <li>{{ line }}</li>
                                {% endif %}
                            {% endfor %}
                        </ul>
                    {% endif %}
                    <div class="article-meta">
                        <div class="meta-line">
                            <span class="source">{{ color_article.source }}</span>
                            {% if color_article.pub_date %}
                                <span class="pub-date">{{ color_article.pub_date|date:"M d, Y" }}</span>
                            {% endif %}
                        </div>
                        {% if color_article.topics %}
                            <div class="topics">
                                {% for topic in color_article.topics %}
                                    <span class="topic">{{ topic }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </article>
            {% else %}
                <div class="empty-state">No local color yet</div>
            {% endif %}
            </div>
        </section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Animation helper - toggles between two frames
            function startChompAnimation(img) {
                const frame1 = img.dataset.frame1;
                const frame2 = img.dataset.frame2;
                let showingFrame1 = true;

                img._animationInterval = setInterval(() => {
                    showingFrame1 = !showingFrame1;
                    img.src = showingFrame1 ? frame1 : frame2;
                }, 250); // 250ms per frame = 2 frames per half second
            }

            function stopChompAnimation(img) {
                if (img._animationInterval) {
                    clearInterval(img._animationInterval);
                    img._animationInterval = null;
                }
                img.src = img.dataset.frame1; // Reset to original frame
            }

            // Use event delegation for dynamically loaded buttons
            document.querySelector('.feed').addEventListener('click', async function(e) {
                const button = e.target.closest('.refresh-btn');
                if (!button) return;

                e.preventDefault();

                if (button.classList.contains('loading')) return;

                const category = button.getAttribute('data-category');
                const contentDiv = document.getElementById(category + '-content');

                // Show loading state and start animation
                button.classList.add('loading');
                startChompAnimation(button);

                try {
                    const response = await fetch(`/refresh/${category}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken'),
                            'Content-Type': 'application/json',
                        },
                    });

                    const data = await response.json();

                    if (data.success) {
                        // Update the content with the new article
                        contentDiv.innerHTML = data.html;
                    } else {
                        alert(data.error || 'Failed to fetch new article');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Failed to fetch new article');
                } finally {
                    // Stop animation and remove loading state
                    stopChompAnimation(button);
                    button.classList.remove('loading');
                }
            });

            // Helper function to get CSRF token
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
        });
    </script>
</body>
</html>
