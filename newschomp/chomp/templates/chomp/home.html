{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Newschomp</title>
    <link rel="stylesheet" href="{% static 'chomp/css/style.css' %}">
</head>
<body>
    <main class="feed">
        <section class="feed-section feed-world">
            <div id="world-content">
            {% include 'chomp/article_partial.html' with article=world_article category='world' llm_model=llm_model %}
            </div>
        </section>

        <div class="section-separator">-- -  *  - --</div>

        <section class="feed-section feed-color">
            <div id="color-content">
            {% include 'chomp/article_partial.html' with article=color_article category='color' llm_model=llm_model %}
            </div>
        </section>

        <section class="feed-section feed-test">
            <div class="test-url-form">
                <input type="text" id="test-url-input" placeholder="Enter article URL to test..." />
                <button id="test-url-btn" type="button">Test</button>
            </div>
        </section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Title formatting - split hyphenated words, format for desktop/mobile
            function formatTitles() {
                const isMobile = window.innerWidth <= 600;

                document.querySelectorAll('.article-title a').forEach(link => {
                    // Store original text if not already stored
                    if (!link.dataset.originalText) {
                        link.dataset.originalText = link.textContent.trim();
                    }

                    // Skip if already formatted for current mode
                    if (link.dataset.formatted === (isMobile ? 'mobile' : 'desktop')) return;

                    const text = link.dataset.originalText;
                    // Split on whitespace first
                    const spaceWords = text.split(/\s+/);

                    // Only split hyphenated words if it keeps us at 4 words or fewer
                    // (e.g., 3 words with 1 hyphenated -> 4 words = OK)
                    // (e.g., 4 words with 1 hyphenated -> 5 words = don't split)
                    const words = [];
                    spaceWords.forEach(word => {
                        if (word.includes('-') && spaceWords.length < 4) {
                            // Split on hyphen but keep it with left part
                            const parts = word.split('-');
                            for (let i = 0; i < parts.length; i++) {
                                if (i < parts.length - 1) {
                                    words.push(parts[i] + '-');
                                } else {
                                    words.push(parts[i]);
                                }
                            }
                        } else {
                            words.push(word);
                        }
                    });

                    if (isMobile) {
                        // Mobile: Group words into pairs, each pair on its own line
                        const lines = [];
                        for (let i = 0; i < words.length; i += 2) {
                            const word1 = words[i];
                            const word2 = words[i + 1];
                            if (word2) {
                                lines.push(`<span class="title-line"><span class="title-word">${word1}</span><span class="title-word">${word2}</span></span>`);
                            } else {
                                lines.push(`<span class="title-line"><span class="title-word">${word1}</span></span>`);
                            }
                        }
                        link.innerHTML = lines.join('');
                        link.dataset.formatted = 'mobile';
                    } else {
                        // Desktop: All words on one line, spaced evenly
                        link.innerHTML = words.join(' ');
                        link.dataset.formatted = 'desktop';
                    }
                });
            }

            // Run on load
            formatTitles();

            // Re-run on resize (in case orientation changes)
            window.addEventListener('resize', formatTitles);

            // Animation helper - toggles between two frames
            function startChompAnimation(img) {
                const frame1 = img.dataset.frame1;
                const frame2 = img.dataset.frame2;
                let showingFrame1 = false;

                // Immediately show frame2 to start animation without delay
                img.src = frame2;

                img._animationInterval = setInterval(() => {
                    showingFrame1 = !showingFrame1;
                    img.src = showingFrame1 ? frame1 : frame2;
                }, 250); // 250ms per frame = 2 frames per half second
            }

            function stopChompAnimation(img) {
                if (img._animationInterval) {
                    clearInterval(img._animationInterval);
                    img._animationInterval = null;
                }
                img.src = img.dataset.frame1; // Reset to original frame
            }

            // Fetch initial articles asynchronously on page load
            async function loadInitialArticle(category) {
                const contentDiv = document.getElementById(category + '-content');
                // Find mouth button - could be in button-row or directly in empty-state
                const mouthBtn = contentDiv.querySelector('.refresh-btn');

                if (mouthBtn) {
                    mouthBtn.classList.add('loading');
                    startChompAnimation(mouthBtn);
                }

                try {
                    const response = await fetch(`/refresh/${category}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken'),
                            'Content-Type': 'application/json',
                        },
                    });

                    const data = await response.json();
                    if (data.success) {
                        contentDiv.innerHTML = data.html;
                        formatTitles();
                    }
                } catch (error) {
                    console.error(`Error loading initial ${category} article:`, error);
                } finally {
                    if (mouthBtn) {
                        stopChompAnimation(mouthBtn);
                        mouthBtn.classList.remove('loading');
                    }
                }
            }

            // Load both articles in parallel (skip if ?empty=1 in URL for design testing)
            const urlParams = new URLSearchParams(window.location.search);
            if (!urlParams.has('empty')) {
                loadInitialArticle('world');
                loadInitialArticle('color');
            }

            // Use event delegation for dynamically loaded buttons
            document.querySelector('.feed').addEventListener('click', async function(e) {
                // Handle local chomp button clicks
                const localChompBtn = e.target.closest('.local-chomp-btn');
                if (localChompBtn) {
                    console.log('getting locational');

                    // Prevent double-clicks
                    if (localChompBtn.disabled) return;

                    // Get the mouth button in the same button-row for animation
                    const buttonRow = localChompBtn.closest('.button-row');
                    const mouthBtn = buttonRow ? buttonRow.querySelector('.refresh-btn') : null;
                    const contentDiv = document.getElementById('color-content');

                    // Request geolocation permission
                    if (!navigator.geolocation) {
                        console.log('Geolocation not supported by browser');
                        alert('Geolocation is not supported by your browser');
                        return;
                    }

                    // Disable button and start animation
                    localChompBtn.disabled = true;
                    if (mouthBtn) {
                        mouthBtn.classList.add('loading');
                        startChompAnimation(mouthBtn);
                    }

                    navigator.geolocation.getCurrentPosition(
                        async (position) => {
                            const { latitude, longitude } = position.coords;
                            console.log(`User location: ${latitude}, ${longitude}`);

                            try {
                                // Find nearest source
                                const nearestResponse = await fetch('/nearest-source/', {
                                    method: 'POST',
                                    headers: {
                                        'X-CSRFToken': getCookie('csrftoken'),
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({ latitude, longitude })
                                });

                                const nearestData = await nearestResponse.json();
                                if (!nearestData.success) {
                                    throw new Error(nearestData.error || 'Failed to find nearest source');
                                }

                                console.log(`Nearest source: ${nearestData.source.name} (${nearestData.source.city}) - ${nearestData.source.distance_km} km away`);

                                // Fetch article from that source
                                const fetchResponse = await fetch(`/fetch-local/${nearestData.source.source_key}/`, {
                                    method: 'POST',
                                    headers: {
                                        'X-CSRFToken': getCookie('csrftoken'),
                                        'Content-Type': 'application/json',
                                    },
                                });

                                const fetchData = await fetchResponse.json();
                                if (fetchData.success) {
                                    // Update the content with the new article
                                    contentDiv.innerHTML = fetchData.html;
                                    // Re-format titles
                                    formatTitles();
                                    console.log(`Loaded article from ${fetchData.source_name} (${fetchData.source_city})`);
                                } else {
                                    alert(fetchData.error || 'Failed to fetch article from nearest source');
                                }
                            } catch (error) {
                                console.error('Error:', error);
                                alert('Failed to fetch local article: ' + error.message);
                            } finally {
                                // Stop animation and re-enable button
                                // Need to get the new mouth button since DOM was replaced
                                const newButtonRow = contentDiv.querySelector('.button-row');
                                const newMouthBtn = newButtonRow ? newButtonRow.querySelector('.refresh-btn') : null;
                                const newLocalBtn = newButtonRow ? newButtonRow.querySelector('.local-chomp-btn') : null;

                                if (newMouthBtn) {
                                    stopChompAnimation(newMouthBtn);
                                    newMouthBtn.classList.remove('loading');
                                }
                                if (newLocalBtn) {
                                    newLocalBtn.disabled = false;
                                }
                            }
                        },
                        (error) => {
                            console.log('Geolocation error:', error.code, error.message);
                            let errorMsg;
                            switch (error.code) {
                                case 1: // PERMISSION_DENIED
                                    if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
                                        errorMsg = 'Location requires HTTPS. Please access the site via https://';
                                    } else {
                                        errorMsg = 'Location permission denied. Please enable location access in your browser settings and reload the page.';
                                    }
                                    break;
                                case 2: // POSITION_UNAVAILABLE
                                    errorMsg = 'Location unavailable. Please check that location services are enabled on your device.';
                                    break;
                                case 3: // TIMEOUT
                                    errorMsg = 'Location request timed out. Please try again.';
                                    break;
                                default:
                                    errorMsg = 'Unable to get your location: ' + error.message;
                            }
                            alert(errorMsg);
                            // Stop animation and re-enable button
                            if (mouthBtn) {
                                stopChompAnimation(mouthBtn);
                                mouthBtn.classList.remove('loading');
                            }
                            localChompBtn.disabled = false;
                        }
                    );
                    return;
                }

                const button = e.target.closest('.refresh-btn');
                if (!button) return;

                e.preventDefault();

                if (button.classList.contains('loading')) return;

                const category = button.getAttribute('data-category');
                const contentDiv = document.getElementById(category + '-content');

                // Show loading state and start animation
                button.classList.add('loading');
                startChompAnimation(button);

                try {
                    const response = await fetch(`/refresh/${category}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken'),
                            'Content-Type': 'application/json',
                        },
                    });

                    const data = await response.json();

                    if (data.success) {
                        // Update the content with the new article
                        contentDiv.innerHTML = data.html;
                        // Re-format titles
                        formatTitles();
                    } else {
                        alert(data.error || 'Failed to fetch new article');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Failed to fetch new article');
                } finally {
                    // Stop animation and remove loading state
                    stopChompAnimation(button);
                    button.classList.remove('loading');
                }
            });

            // Test URL form handler
            document.getElementById('test-url-btn').addEventListener('click', async function() {
                const input = document.getElementById('test-url-input');
                const url = input.value.trim();
                const btn = this;

                if (!url) {
                    alert('Please enter a URL');
                    return;
                }

                btn.disabled = true;
                btn.textContent = 'Loading...';

                try {
                    const response = await fetch('/test-url/', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken'),
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ url: url })
                    });

                    const data = await response.json();
                    if (data.success) {
                        // Load into the appropriate section based on category
                        const contentDiv = document.getElementById(data.category + '-content');
                        contentDiv.innerHTML = data.html;
                        formatTitles();
                        // Scroll to the section so user can see it
                        contentDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        console.log(`Loaded article from ${data.source_name} into ${data.category}`);
                    } else {
                        alert('Error: ' + data.error);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Failed to fetch: ' + error.message);
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'Test';
                }
            });

            // Allow Enter key to submit
            document.getElementById('test-url-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('test-url-btn').click();
                }
            });

            // Helper function to get CSRF token
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
        });
    </script>
</body>
</html>
