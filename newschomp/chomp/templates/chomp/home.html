{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Newschomp</title>
    <link rel="stylesheet" href="{% static 'chomp/css/style.css' %}">
</head>
<body>
    <main class="feed">
        <section class="feed-section feed-world">
            <div id="world-content">
            {% if world_article %}
                <article class="article-card">
                    <img src="{% static 'chomp/images/mouth.png' %}" alt="Refresh" title="GENERATE NEW CHOMP" class="refresh-btn" data-category="world" data-frame1="{% static 'chomp/images/mouth.png' %}" data-frame2="{% static 'chomp/images/mouth-2.png' %}">
                    <h3 class="article-title">
                        <a href="{{ world_article.url }}" target="_blank" title="{{ world_article.url }}">
                            {% if world_article.ai_title %}
                                {{ world_article.ai_title }}
                            {% else %}
                                {{ world_article.title }}
                            {% endif %}
                        </a>
                    </h3>
                    {% if world_article.image_url %}
                        <img src="{{ world_article.image_url }}" alt="{{ world_article.title }}" class="article-image">
                    {% endif %}
                    {% if world_article.summary %}
                        <ul class="summary">
                            {% for line in world_article.summary.splitlines %}
                                {% if line.strip %}
                                    <li>{{ line }}</li>
                                {% endif %}
                            {% endfor %}
                        </ul>
                    {% endif %}
                    <div class="article-meta">
                        <div class="meta-line">
                            <span class="source">{{ world_article.source }}</span>
                            {% if world_article.pub_date %}
                                <span class="pub-date">{{ world_article.pub_date|date:"M d, Y" }}</span>
                            {% endif %}
                        </div>
                        {% if world_article.topics %}
                            <div class="topics">
                                {% for topic in world_article.topics %}
                                    <span class="topic">{{ topic }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </article>
            {% else %}
                <div class="empty-state">
                    <img src="{% static 'chomp/images/mouth.png' %}" alt="Refresh" title="GENERATE NEW CHOMP" class="refresh-btn" data-category="world" data-frame1="{% static 'chomp/images/mouth.png' %}" data-frame2="{% static 'chomp/images/mouth-2.png' %}">
                    No world news yet
                </div>
            {% endif %}
            </div>
        </section>

        <section class="feed-section feed-color">
            <div id="color-content">
            {% if color_article %}
                <article class="article-card">
                    <div class="button-row">
                        <img src="{% static 'chomp/images/mouth.png' %}" alt="Refresh" title="GENERATE NEW CHOMP" class="refresh-btn" data-category="color" data-frame1="{% static 'chomp/images/mouth.png' %}" data-frame2="{% static 'chomp/images/mouth-2.png' %}">
                        <button class="local-chomp-btn">gen. local chomp!</button>
                    </div>
                    <h3 class="article-title">
                        <a href="{{ color_article.url }}" target="_blank" title="{{ color_article.url }}">
                            {% if color_article.ai_title %}
                                {{ color_article.ai_title }}
                            {% else %}
                                {{ color_article.title }}
                            {% endif %}
                        </a>
                    </h3>
                    {% if color_article.image_url %}
                        <img src="{{ color_article.image_url }}" alt="{{ color_article.title }}" class="article-image">
                    {% endif %}
                    {% if color_article.summary %}
                        <ul class="summary">
                            {% for line in color_article.summary.splitlines %}
                                {% if line.strip %}
                                    <li>{{ line }}</li>
                                {% endif %}
                            {% endfor %}
                        </ul>
                    {% endif %}
                    <div class="article-meta">
                        <div class="meta-line">
                            <span class="source">{{ color_article.source }}</span>
                            {% if color_article.pub_date %}
                                <span class="pub-date">{{ color_article.pub_date|date:"M d, Y" }}</span>
                            {% endif %}
                        </div>
                        {% if color_article.topics %}
                            <div class="topics">
                                {% for topic in color_article.topics %}
                                    <span class="topic">{{ topic }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </article>
            {% else %}
                <div class="empty-state">
                    <img src="{% static 'chomp/images/mouth.png' %}" alt="Refresh" title="GENERATE NEW CHOMP" class="refresh-btn" data-category="color" data-frame1="{% static 'chomp/images/mouth.png' %}" data-frame2="{% static 'chomp/images/mouth-2.png' %}">
                    No local color yet
                </div>
            {% endif %}
            </div>
        </section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Mobile title formatting - 2 words per line, justified left/right
            function formatMobileTitles() {
                if (window.innerWidth > 480) return;

                document.querySelectorAll('.article-title a').forEach(link => {
                    // Skip if already formatted
                    if (link.dataset.formatted) return;

                    const text = link.textContent.trim();
                    // Split on whitespace, then split hyphenated words (keeping hyphen with first part)
                    const words = text.split(/\s+/).flatMap(word =>
                        word.split(/(?<=-)/)
                    );

                    // Group words into pairs, each word in its own span
                    const lines = [];
                    for (let i = 0; i < words.length; i += 2) {
                        const word1 = words[i];
                        const word2 = words[i + 1];
                        if (word2) {
                            lines.push(`<span class="title-line"><span class="title-word">${word1}</span><span class="title-word">${word2}</span></span>`);
                        } else {
                            lines.push(`<span class="title-line"><span class="title-word">${word1}</span></span>`);
                        }
                    }

                    link.innerHTML = lines.join('');
                    link.dataset.formatted = 'true';
                });
            }

            // Run on load
            formatMobileTitles();

            // Re-run on resize (in case orientation changes)
            window.addEventListener('resize', formatMobileTitles);

            // Animation helper - toggles between two frames
            function startChompAnimation(img) {
                const frame1 = img.dataset.frame1;
                const frame2 = img.dataset.frame2;
                let showingFrame1 = false;

                // Immediately show frame2 to start animation without delay
                img.src = frame2;

                img._animationInterval = setInterval(() => {
                    showingFrame1 = !showingFrame1;
                    img.src = showingFrame1 ? frame1 : frame2;
                }, 250); // 250ms per frame = 2 frames per half second
            }

            function stopChompAnimation(img) {
                if (img._animationInterval) {
                    clearInterval(img._animationInterval);
                    img._animationInterval = null;
                }
                img.src = img.dataset.frame1; // Reset to original frame
            }

            // Use event delegation for dynamically loaded buttons
            document.querySelector('.feed').addEventListener('click', async function(e) {
                // Handle local chomp button clicks
                const localChompBtn = e.target.closest('.local-chomp-btn');
                if (localChompBtn) {
                    console.log('getting locational');

                    // Prevent double-clicks
                    if (localChompBtn.disabled) return;

                    // Get the mouth button in the same button-row for animation
                    const buttonRow = localChompBtn.closest('.button-row');
                    const mouthBtn = buttonRow ? buttonRow.querySelector('.refresh-btn') : null;
                    const contentDiv = document.getElementById('color-content');

                    // Request geolocation permission
                    if (!navigator.geolocation) {
                        console.log('Geolocation not supported by browser');
                        alert('Geolocation is not supported by your browser');
                        return;
                    }

                    // Disable button and start animation
                    localChompBtn.disabled = true;
                    if (mouthBtn) {
                        mouthBtn.classList.add('loading');
                        startChompAnimation(mouthBtn);
                    }

                    navigator.geolocation.getCurrentPosition(
                        async (position) => {
                            const { latitude, longitude } = position.coords;
                            console.log(`User location: ${latitude}, ${longitude}`);

                            try {
                                // Find nearest source
                                const nearestResponse = await fetch('/nearest-source/', {
                                    method: 'POST',
                                    headers: {
                                        'X-CSRFToken': getCookie('csrftoken'),
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({ latitude, longitude })
                                });

                                const nearestData = await nearestResponse.json();
                                if (!nearestData.success) {
                                    throw new Error(nearestData.error || 'Failed to find nearest source');
                                }

                                console.log(`Nearest source: ${nearestData.source.name} (${nearestData.source.city}) - ${nearestData.source.distance_km} km away`);

                                // Fetch article from that source
                                const fetchResponse = await fetch(`/fetch-local/${nearestData.source.source_key}/`, {
                                    method: 'POST',
                                    headers: {
                                        'X-CSRFToken': getCookie('csrftoken'),
                                        'Content-Type': 'application/json',
                                    },
                                });

                                const fetchData = await fetchResponse.json();
                                if (fetchData.success) {
                                    // Update the content with the new article
                                    contentDiv.innerHTML = fetchData.html;
                                    // Re-format titles for mobile
                                    formatMobileTitles();
                                    console.log(`Loaded article from ${fetchData.source_name} (${fetchData.source_city})`);
                                } else {
                                    alert(fetchData.error || 'Failed to fetch article from nearest source');
                                }
                            } catch (error) {
                                console.error('Error:', error);
                                alert('Failed to fetch local article: ' + error.message);
                            } finally {
                                // Stop animation and re-enable button
                                // Need to get the new mouth button since DOM was replaced
                                const newButtonRow = contentDiv.querySelector('.button-row');
                                const newMouthBtn = newButtonRow ? newButtonRow.querySelector('.refresh-btn') : null;
                                const newLocalBtn = newButtonRow ? newButtonRow.querySelector('.local-chomp-btn') : null;

                                if (newMouthBtn) {
                                    stopChompAnimation(newMouthBtn);
                                    newMouthBtn.classList.remove('loading');
                                }
                                if (newLocalBtn) {
                                    newLocalBtn.disabled = false;
                                }
                            }
                        },
                        (error) => {
                            console.log('Geolocation error:', error.message);
                            alert('Unable to get your location: ' + error.message);
                            // Stop animation and re-enable button
                            if (mouthBtn) {
                                stopChompAnimation(mouthBtn);
                                mouthBtn.classList.remove('loading');
                            }
                            localChompBtn.disabled = false;
                        }
                    );
                    return;
                }

                const button = e.target.closest('.refresh-btn');
                if (!button) return;

                e.preventDefault();

                if (button.classList.contains('loading')) return;

                const category = button.getAttribute('data-category');
                const contentDiv = document.getElementById(category + '-content');

                // Show loading state and start animation
                button.classList.add('loading');
                startChompAnimation(button);

                try {
                    const response = await fetch(`/refresh/${category}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken'),
                            'Content-Type': 'application/json',
                        },
                    });

                    const data = await response.json();

                    if (data.success) {
                        // Update the content with the new article
                        contentDiv.innerHTML = data.html;
                        // Re-format titles for mobile
                        formatMobileTitles();
                    } else {
                        alert(data.error || 'Failed to fetch new article');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Failed to fetch new article');
                } finally {
                    // Stop animation and remove loading state
                    stopChompAnimation(button);
                    button.classList.remove('loading');
                }
            });

            // Helper function to get CSRF token
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
        });
    </script>
</body>
</html>
